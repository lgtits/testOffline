import{b1 as ee,a as he,ab as w}from"./index.125062c9.js";var Ee=Object.defineProperty,$e=(e,t,s)=>t in e?Ee(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,_=(e,t,s)=>($e(e,typeof t!="symbol"?t+"":t,s),s),te=new Intl.Collator(0,{numeric:1}).compare;function de(e,t,s){return e=e.split("."),t=t.split("."),te(e[0],t[0])||te(e[1],t[1])||(t[2]=t.slice(2).join("."),s=/[.-]/.test(e[2]=e.slice(2).join(".")),s==/[.-]/.test(t[2])?te(e[2],t[2]):s?-1:1)}const De="upload",Oe="config",je="info",Ae="runtime",Pe="sleeptime",Ne="https://gradio-space-api-fetcher-v2.hf.space/api",fe="This application is currently busy. Please try again. ",F="Connection errored out. ",J="Could not resolve app config. ",Te="Could not get space status. ",Ce="Could not get API info. ",Re="Space metadata could not be loaded. ";function _e(e,t,s){return t.startsWith("http://")||t.startsWith("https://")?s?e:t:e+t}async function ke(e,t){try{return(await(await fetch(`https://huggingface.co/api/spaces/${e}/jwt`,{headers:{Authorization:`Bearer ${t}`}})).json()).token||!1}catch{return!1}}function qe(e){let t={};return e.forEach(({api_name:s},o)=>{s&&(t[s]=o)}),t}async function Ie(e){const t=this.options.hf_token?{Authorization:`Bearer ${this.options.hf_token}`}:{};if(t["Content-Type"]="application/json",typeof window<"u"&&window.gradio_config&&location.origin!=="http://localhost:9876"&&!window.gradio_config.dev_mode){const s=window.gradio_config.root,o=window.gradio_config;let n=_e(e,o.root,!1);return o.root=n,{...o,path:s}}else if(e){const s=await this.fetch(`${e}/${Oe}`,{headers:t});if(s?.status===200){let o=await s.json();return o.path=o.path??"",o.root=e,o}throw new Error(J)}throw new Error(J)}function se(e){if(e.startsWith("http")){const{protocol:t,host:s}=new URL(e);return s.endsWith("hf.space")?{ws_protocol:"wss",host:s,http_protocol:t}:{ws_protocol:t==="https:"?"wss":"ws",http_protocol:t,host:s}}else if(e.startsWith("file:"))return{ws_protocol:"ws",http_protocol:"http:",host:"lite.local"};return{ws_protocol:"wss",http_protocol:"https:",host:e}}const me=/^[^\/]*\/[^\/]*$/,Ue=/.*hf\.space\/{0,1}$/;async function ge(e,t){const s={};t&&(s.Authorization=`Bearer ${t}`);const o=e.trim();if(me.test(o))try{const r=(await(await fetch(`https://huggingface.co/api/spaces/${o}/host`,{headers:s})).json()).host;return{space_id:e,...se(r)}}catch(n){throw new Error("Space metadata could not be loaded. "+n.message)}if(Ue.test(o)){const{ws_protocol:n,http_protocol:r,host:a}=se(o);return{space_id:a.replace(".hf.space",""),ws_protocol:n,http_protocol:r,host:a}}return{space_id:!1,...se(o)}}function Be(e,t,s){const o={named_endpoints:{},unnamed_endpoints:{}};return Object.keys(e).forEach(n=>{(n==="named_endpoints"||n==="unnamed_endpoints")&&(o[n]={},Object.entries(e[n]).forEach(([r,{parameters:a,returns:i}])=>{var l,d;const f=t.dependencies.findIndex(m=>m.api_name===r||m.api_name===r.replace("/",""))||s[r.replace("/","")]||-1,c=f!==-1?t.dependencies[f].types:{continuous:!1,generator:!1};if(f!==-1&&((d=(l=t.dependencies[f])==null?void 0:l.inputs)==null?void 0:d.length)!==a.length){const m=t.dependencies[f].inputs.map(A=>{var T;return(T=t.components.find(k=>k.id===A))==null?void 0:T.type});try{m.forEach((A,T)=>{if(A==="state"){const k={component:"state",example:null,parameter_default:null,parameter_has_default:!0,parameter_name:null,hidden:!0};a.splice(T,0,k)}})}catch{}}const p=(m,A,T,k)=>({...m,description:ze(m?.type,T),type:Le(m?.type,A,T,k)||""});o[n][r]={parameters:a.map(m=>p(m,m?.component,m?.serializer,"parameter")),returns:i.map(m=>p(m,m?.component,m?.serializer,"return")),type:c}}))}),o}function Le(e,t,s,o){switch(e?.type){case"string":return"string";case"boolean":return"boolean";case"number":return"number"}if(s==="JSONSerializable"||s==="StringSerializable")return"any";if(s==="ListStringSerializable")return"string[]";if(t==="Image")return o==="parameter"?"Blob | File | Buffer":"string";if(s==="FileSerializable")return e?.type==="array"?o==="parameter"?"(Blob | File | Buffer)[]":"{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}[]":o==="parameter"?"Blob | File | Buffer":"{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}";if(s==="GallerySerializable")return o==="parameter"?"[(Blob | File | Buffer), (string | null)][]":"[{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}, (string | null))][]"}function ze(e,t){return t==="GallerySerializable"?"array of [file, label] tuples":t==="ListStringSerializable"?"array of strings":t==="FileSerializable"?"array of files or single file":e?.description}function ne(e,t){switch(e.msg){case"send_data":return{type:"data"};case"send_hash":return{type:"hash"};case"queue_full":return{type:"update",status:{queue:!0,message:fe,stage:"error",code:e.code,success:e.success}};case"heartbeat":return{type:"heartbeat"};case"unexpected_error":return{type:"unexpected_error",status:{queue:!0,message:e.message,stage:"error",success:!1}};case"estimation":return{type:"update",status:{queue:!0,stage:t||"pending",code:e.code,size:e.queue_size,position:e.rank,eta:e.rank_eta,success:e.success}};case"progress":return{type:"update",status:{queue:!0,stage:"pending",code:e.code,progress_data:e.progress_data,success:e.success}};case"log":return{type:"log",data:e};case"process_generating":return{type:"generating",status:{queue:!0,message:e.success?null:e.output.error,stage:e.success?"generating":"error",code:e.code,progress_data:e.progress_data,eta:e.average_duration},data:e.success?e.output:null};case"process_completed":return"error"in e.output?{type:"update",status:{queue:!0,message:e.output.error,stage:"error",code:e.code,success:e.success}}:{type:"complete",status:{queue:!0,message:e.success?void 0:e.output.error,stage:e.success?"complete":"error",code:e.code,progress_data:e.progress_data},data:e.success?e.output:null};case"process_starts":return{type:"update",status:{queue:!0,stage:"pending",code:e.code,size:e.rank,position:0,success:e.success,eta:e.eta}}}return{type:"none",status:{stage:"error",queue:!0}}}const xe=(e,t)=>{const s=Object.values(t.named_endpoints).flatMap(r=>r.parameters);if(Array.isArray(e))return e.length>s.length&&console.warn("Too many arguments provided for the endpoint."),e;const o=[],n=Object.keys(e);return s.forEach((r,a)=>{if(e.hasOwnProperty(r.parameter_name))o[a]=e[r.parameter_name];else if(r.parameter_has_default)o[a]=r.parameter_default;else throw new Error(`No value provided for required parameter: ${r.parameter_name}`)}),n.forEach(r=>{if(!s.some(a=>a.parameter_name===r))throw new Error(`Parameter \`${r}\` is not a valid keyword argument. Please refer to the API for usage.`)}),o.forEach((r,a)=>{if(r===void 0&&!s[a].parameter_has_default)throw new Error(`No value provided for required parameter: ${s[a].parameter_name}`)}),o};async function Ge(){if(this.api_info)return this.api_info;const{hf_token:e}=this.options,{config:t}=this,s={"Content-Type":"application/json"};if(e&&(s.Authorization=`Bearer ${e}`),!!t)try{let o;if(de(t?.version||"2.0.0","3.30")<0?o=await this.fetch(Ne,{method:"POST",body:JSON.stringify({serialize:!1,config:JSON.stringify(t)}),headers:s}):o=await this.fetch(`${t?.root}/${je}`,{headers:s}),!o.ok)throw new Error(F);let n=await o.json();return"api"in n&&(n=n.api),n.named_endpoints["/predict"]&&!n.unnamed_endpoints[0]&&(n.unnamed_endpoints[0]=n.named_endpoints["/predict"]),Be(n,t,this.api_map)}catch(o){""+o.message}}async function Fe(e,t,s){var o;const n={};(o=this==null?void 0:this.options)!=null&&o.hf_token&&(n.Authorization=`Bearer ${this.options.hf_token}`);const r=1e3,a=[];let i;for(let l=0;l<t.length;l+=r){const d=t.slice(l,l+r),f=new FormData;d.forEach(p=>{f.append("files",p)});try{const p=s?`${e}/upload?upload_id=${s}`:`${e}/${De}`;i=await this.fetch(p,{method:"POST",body:f,headers:n})}catch(p){throw new Error(F+p.message)}if(!i.ok){const p=await i.text();return{error:`HTTP ${i.status}: ${p}`}}const c=await i.json();c&&a.push(...c)}return{files:a}}async function Me(e,t,s,o){let n=(Array.isArray(e)?e:[e]).map(a=>a.blob);const r=n.filter(a=>a.size>(o??1/0));if(r.length)throw new Error(`File size exceeds the maximum allowed size of ${o} bytes: ${r.map(a=>a.name).join(", ")}`);return await Promise.all(await this.upload_files(t,n,s).then(async a=>{if(a.error)throw new Error(a.error);return a.files?a.files.map((i,l)=>new we({...e[l],path:i,url:t+"/file="+i})):[]}))}class we{constructor({path:t,url:s,orig_name:o,size:n,blob:r,is_stream:a,mime_type:i,alt_text:l}){_(this,"path"),_(this,"url"),_(this,"orig_name"),_(this,"size"),_(this,"blob"),_(this,"is_stream"),_(this,"mime_type"),_(this,"alt_text"),_(this,"meta",{_type:"gradio.FileData"}),this.path=t,this.url=s,this.orig_name=o,this.size=n,this.blob=s?void 0:r,this.is_stream=a,this.mime_type=i,this.alt_text=l}}function ce(e,t,s){for(;s.length>1;){const n=s.shift();if(typeof n=="string"||typeof n=="number")e=e[n];else throw new Error("Invalid key type")}const o=s.shift();if(typeof o=="string"||typeof o=="number")e[o]=t;else throw new Error("Invalid key type")}async function oe(e,t=void 0,s=[],o=!1,n=void 0){if(Array.isArray(e)){let r=[];return await Promise.all(e.map(async a=>{var i;let l=s.slice();l.push(a);const d=await oe(e[a],o?((i=n?.parameters[a])==null?void 0:i.component)||void 0:t,l,!1,n);r=r.concat(d)})),r}else{if(globalThis.Buffer&&e instanceof globalThis.Buffer||e instanceof Blob)return[{path:s,blob:t==="Image"?!1:new ae([e]),type:t}];if(typeof e=="object"&&e!==null){let r=[];for(const a of Object.keys(e)){const i=[...s,a],l=e[a];r=r.concat(await oe(l,void 0,i,!1,n))}return!r.length&&!(e instanceof Blob||e instanceof ArrayBuffer||e instanceof Uint8Array)?[{path:s,blob:new ae([JSON.stringify(e)]),type:typeof e}]:r}}return[]}function Je(e,t){var s,o;return((o=(s=t?.dependencies)==null?void 0:s[e])==null?void 0:o.queue)!==null?!t.dependencies[e].queue:!t.enable_queue}function We(e,t){return new Promise((s,o)=>{const n=new MessageChannel;n.port1.onmessage=({data:r})=>{n.port1.close(),s(r)},window.parent.postMessage(e,t,[n.port2])})}async function He(e,t,s){const o=this,n=await oe(t,void 0,[],!0,s);return(await Promise.all(n.map(async({path:a,blob:i,type:l})=>{if(!i)return{path:a,type:l};const d=await o.upload_files(e,[i]),f=d.files&&d.files[0];return{path:a,file_url:f,type:l,name:i instanceof File?i?.name:void 0}}))).forEach(({path:a,file_url:i,type:l,name:d})=>{if(l==="Gallery")ce(t,i,a);else if(i){const f=new we({path:i,orig_name:d});ce(t,f,a)}}),t}async function Ve(e,t,s){const o={"Content-Type":"application/json"};this.options.hf_token&&(o.Authorization=`Bearer ${this.options.hf_token}`);try{var n=await this.fetch(e,{method:"POST",body:JSON.stringify(t),headers:{...o,...s}})}catch{return[{error:F},500]}let r,a;try{r=await n.json(),a=n.status}catch(i){r={error:`Could not parse server response: ${i}`},a=500}return[r,a]}async function Ke(e,t){let s=!1,o=!1,n;if(!this.config)throw new Error("Could not resolve app config");if(typeof e=="number")n=this.config.dependencies[e];else{const r=e.replace(/^\//,"");n=this.config.dependencies[this.api_map[r]]}if(n?.types.continuous)throw new Error("Cannot call predict on this function as it may run forever. Use submit instead");return new Promise(async(r,a)=>{const i=this.submit(e,t);let l;i.on("data",d=>{o&&(i.destroy(),r(d)),s=!0,l=d}).on("status",d=>{d.stage==="error"&&a(d),d.stage==="complete"&&(o=!0,s&&(i.destroy(),r(l)))})})}async function re(e,t,s){let o=t==="subdomain"?`https://huggingface.co/api/spaces/by-subdomain/${e}`:`https://huggingface.co/api/spaces/${e}`,n,r;try{if(n=await fetch(o),r=n.status,r!==200)throw new Error;n=await n.json()}catch{s({status:"error",load_status:"error",message:Te,detail:"NOT_FOUND"});return}if(!n||r!==200)return;const{runtime:{stage:a},id:i}=n;switch(a){case"STOPPED":case"SLEEPING":s({status:"sleeping",load_status:"pending",message:"Space is asleep. Waking it up...",detail:a}),setTimeout(()=>{re(e,t,s)},1e3);break;case"PAUSED":s({status:"paused",load_status:"error",message:"This space has been paused by the author. If you would like to try this demo, consider duplicating the space.",detail:a,discussions_enabled:await le(i)});break;case"RUNNING":case"RUNNING_BUILDING":s({status:"running",load_status:"complete",message:"",detail:a});break;case"BUILDING":s({status:"building",load_status:"pending",message:"Space is building...",detail:a}),setTimeout(()=>{re(e,t,s)},1e3);break;default:s({status:"space_error",load_status:"error",message:"This space is experiencing an issue.",detail:a,discussions_enabled:await le(i)});break}}const Ze=/^(?=[^]*\b[dD]iscussions{0,1}\b)(?=[^]*\b[dD]isabled\b)[^]*$/;async function le(e){try{const s=(await fetch(`https://huggingface.co/api/spaces/${e}/discussions`,{method:"HEAD"})).headers.get("x-error-message");return!(s&&Ze.test(s))}catch{return!1}}async function Qe(e,t){const s={};t&&(s.Authorization=`Bearer ${t}`);try{const o=await fetch(`https://huggingface.co/api/spaces/${e}/${Ae}`,{headers:s});if(o.status!==200)throw new Error("Space hardware could not be obtained.");const{hardware:n}=await o.json();return n.current}catch(o){throw new Error(o.message)}}async function Ye(e,t,s){const o={};s&&(o.Authorization=`Bearer ${s}`);const n={seconds:t};try{const r=await fetch(`https://huggingface.co/api/spaces/${e}/${Pe}`,{method:"POST",headers:{"Content-Type":"application/json",...o},body:JSON.stringify(n)});if(r.status!==200)throw new Error("Could not set sleep timeout on duplicated Space. Please visit *ADD HF LINK TO SETTINGS* to set a timeout manually to reduce billing charges.");return await r.json()}catch(r){throw new Error(r.message)}}const ue=["cpu-basic","cpu-upgrade","cpu-xl","t4-small","t4-medium","a10g-small","a10g-large","a10g-largex2","a10g-largex4","a100-large","zero-a10g","h100","h100x8"];async function Xe(e,t){const{hf_token:s,private:o,hardware:n,timeout:r}=t;if(n&&!ue.includes(n))throw new Error(`Invalid hardware type provided. Valid types are: ${ue.map(p=>`"${p}"`).join(",")}.`);const a={Authorization:`Bearer ${s}`,"Content-Type":"application/json"},i=(await(await fetch("https://huggingface.co/api/whoami-v2",{headers:a})).json()).name,l=e.split("/")[1],d={repository:`${i}/${l}`};o&&(d.private=!0);let f;try{n||(f=await Qe(e,s))}catch(p){throw Error(Re+p.message)}const c=n||f||"cpu-basic";d.hardware=c;try{const p=await fetch(`https://huggingface.co/api/spaces/${e}/duplicate`,{method:"POST",headers:a,body:JSON.stringify(d)});if(p.status===409)try{return await ie.connect(`${i}/${l}`,t)}catch(A){throw console.error("Failed to connect Client instance:",A),A}else if(p.status!==200)throw new Error(p.statusText);const m=await p.json();return await Ye(`${i}/${l}`,r||300,s),await ie.connect(et(m.url),t)}catch(p){throw new Error(p)}}function et(e){const t=/https:\/\/huggingface.co\/spaces\/([^/]+\/[^/]+)/,s=e.match(t);if(s)return s[1]}async function tt(){let{event_callbacks:e,unclosed_events:t,pending_stream_messages:s,stream_status:o,config:n,jwt:r}=this;if(!n)throw new Error("Could not resolve app config");o.open=!0;let a=null,i=new URLSearchParams({session_hash:this.session_hash}).toString(),l=new URL(`${n.root}/queue/data?${i}`);if(r&&l.searchParams.set("__sign",r),a=await this.stream(l),!a){console.warn("Cannot connect to SSE endpoint: "+l.toString());return}a.onmessage=async function(d){let f=JSON.parse(d.data);if(f.msg==="close_stream"){H(o,a);return}const c=f.event_id;if(!c)await Promise.all(Object.keys(e).map(p=>e[p](f)));else if(e[c]&&n){f.msg==="process_completed"&&["sse","sse_v1","sse_v2","sse_v2.1"].includes(n.protocol)&&(t.delete(c),t.size===0&&H(o,a));let p=e[c];typeof window<"u"?window.setTimeout(p,0,f):setImmediate(p,f)}else s[c]||(s[c]=[]),s[c].push(f)},a.onerror=async function(){await Promise.all(Object.keys(e).map(d=>e[d]({msg:"unexpected_error",message:F}))),H(o,a)}}function H(e,t){e&&t&&(e.open=!1,t?.close())}function st(e,t,s){!e[t]?(e[t]=[],s.data.forEach((n,r)=>{e[t][r]=n})):s.data.forEach((n,r)=>{let a=nt(e[t][r],n);e[t][r]=a,s.data[r]=a})}function nt(e,t){return t.forEach(([s,o,n])=>{e=ot(e,o,s,n)}),e}function ot(e,t,s,o){if(t.length===0){if(s==="replace")return o;if(s==="append")return e+o;throw new Error(`Unsupported action: ${s}`)}let n=e;for(let a=0;a<t.length-1;a++)n=n[t[a]];const r=t[t.length-1];switch(s){case"replace":n[r]=o;break;case"append":n[r]+=o;break;case"add":Array.isArray(n)?n.splice(Number(r),0,o):n[r]=o;break;case"delete":Array.isArray(n)?n.splice(Number(r),1):delete n[r];break;default:throw new Error(`Unknown action: ${s}`)}return e}function rt(e,t,s,o){try{let n=function(y){const O=M[y.type]||[];O?.forEach(g=>g(y))},r=function(y,E){const O=M,g=O[y]||[];return O[y]=g,g?.push(E),{on:r,off:a,cancel:Y,destroy:i}},a=function(y,E){const O=M;let g=O[y]||[];return g=g?.filter(I=>I!==E),O[y]=g,{on:r,off:a,cancel:Y,destroy:i}},i=function(){var y;for(const E in M)M&&((y=M[E])==null||y.forEach(O=>{a(E,O)}))};const{hf_token:l}=this.options,{fetch:d,app_reference:f,config:c,session_hash:p,api_info:m,api_map:A,stream_status:T,pending_stream_messages:k,pending_diff_streams:V,event_callbacks:K,unclosed_events:ye,post_data:Z}=this;if(!m)throw new Error("No API found");if(!c)throw new Error("Could not resolve app config");let{fn_index:u,endpoint_info:be,dependency:ve}=at(m,e,A,c),Se=xe(t,m),$,P,q=c.protocol??"ws";const h=typeof e=="number"?"/predict":e;let W,S=null,D=!1;const M={};let Q={},G=typeof window<"u"?new URLSearchParams(window.location.search).toString():"";async function Y(){const y={stage:"complete",queue:!1,time:new Date};D=y,n({...y,type:"status",endpoint:h,fn_index:u});let E={};q==="ws"?($&&$.readyState===0?$.addEventListener("open",()=>{$.close()}):$.close(),E={fn_index:u,session_hash:p}):(P?.close(),E={event_id:S});try{if(!c)throw new Error("Could not resolve app config");await d(`${c.root}/reset`,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(E)})}catch{console.warn("The `/reset` endpoint could not be called. Subsequent endpoint results may be unreliable.")}}return this.handle_blob(c.root,Se,be).then(async y=>{var E;if(W={data:y||[],event_data:s,fn_index:u,trigger_id:o},Je(u,c))n({type:"status",endpoint:h,stage:"pending",queue:!1,fn_index:u,time:new Date}),Z(`${c.root}/run${h.startsWith("/")?h:`/${h}`}${G?"?"+G:""}`,{...W,session_hash:p}).then(([g,I])=>{const U=g.data;I==200?(n({type:"data",endpoint:h,fn_index:u,data:U,time:new Date,event_data:s,trigger_id:o}),n({type:"status",endpoint:h,fn_index:u,stage:"complete",eta:g.average_duration,queue:!1,time:new Date})):n({type:"status",stage:"error",endpoint:h,fn_index:u,message:g.error,queue:!1,time:new Date})}).catch(g=>{n({type:"status",stage:"error",message:g.message,endpoint:h,fn_index:u,queue:!1,time:new Date})});else if(q=="ws"){const{ws_protocol:g,host:I}=await ge(f,l);n({type:"status",stage:"pending",queue:!0,endpoint:h,fn_index:u,time:new Date});let U=new URL(`${g}://${_e(I,c.path,!0)}/queue/join${G?"?"+G:""}`);this.jwt&&U.searchParams.set("__sign",this.jwt),$=new WebSocket(U),$.onclose=C=>{C.wasClean||n({type:"status",stage:"error",broken:!0,message:F,queue:!0,endpoint:h,fn_index:u,time:new Date})},$.onmessage=function(C){const N=JSON.parse(C.data),{type:v,status:j,data:B}=ne(N,Q[u]);if(v==="update"&&j&&!D)n({type:"status",endpoint:h,fn_index:u,time:new Date,...j}),j.stage==="error"&&$.close();else if(v==="hash"){$.send(JSON.stringify({fn_index:u,session_hash:p}));return}else v==="data"?$.send(JSON.stringify({...W,session_hash:p})):v==="complete"?D=j:v==="log"?n({type:"log",log:B.log,level:B.level,endpoint:h,fn_index:u}):v==="generating"&&n({type:"status",time:new Date,...j,stage:j?.stage,queue:!0,endpoint:h,fn_index:u});B&&(n({type:"data",time:new Date,data:B.data,endpoint:h,fn_index:u,event_data:s,trigger_id:o}),D&&(n({type:"status",time:new Date,...D,stage:j?.stage,queue:!0,endpoint:h,fn_index:u}),$.close()))},de(c.version||"2.0.0","3.6")<0&&addEventListener("open",()=>$.send(JSON.stringify({hash:p})))}else if(q=="sse"){n({type:"status",stage:"pending",queue:!0,endpoint:h,fn_index:u,time:new Date});var O=new URLSearchParams({fn_index:u.toString(),session_hash:p}).toString();let g=new URL(`${c.root}/queue/join?${G?G+"&":""}${O}`);if(this.jwt&&g.searchParams.set("__sign",this.jwt),P=await this.stream(g),!P)return Promise.reject(new Error("Cannot connect to SSE endpoint: "+g.toString()));P.onmessage=async function(I){const U=JSON.parse(I.data),{type:C,status:N,data:v}=ne(U,Q[u]);if(C==="update"&&N&&!D)n({type:"status",endpoint:h,fn_index:u,time:new Date,...N}),N.stage==="error"&&P?.close();else if(C==="data"){S=U.event_id;let[j,B]=await Z(`${c.root}/queue/data`,{...W,session_hash:p,event_id:S});B!==200&&(n({type:"status",stage:"error",message:F,queue:!0,endpoint:h,fn_index:u,time:new Date}),P?.close())}else C==="complete"?D=N:C==="log"?n({type:"log",log:v.log,level:v.level,endpoint:h,fn_index:u}):C==="generating"&&n({type:"status",time:new Date,...N,stage:N?.stage,queue:!0,endpoint:h,fn_index:u});v&&(n({type:"data",time:new Date,data:v.data,endpoint:h,fn_index:u,event_data:s,trigger_id:o}),D&&(n({type:"status",time:new Date,...D,stage:N?.stage,queue:!0,endpoint:h,fn_index:u}),P?.close()))}}else if(q=="sse_v1"||q=="sse_v2"||q=="sse_v2.1"||q=="sse_v3"){n({type:"status",stage:"pending",queue:!0,endpoint:h,fn_index:u,time:new Date});let g="";typeof window<"u"&&(g=(E=window?.location)==null?void 0:E.hostname);let I="dev.spaces.huggingface.tech";const U=g.includes(".dev.")?`https://moon-${g.split(".")[1]}.${I}`:"https://huggingface.co";(ve.zerogpu&&window.parent!=window&&c.space_id?We("zerogpu-headers",U):Promise.resolve(null)).then(v=>Z(`${c.root}/queue/join?${G}`,{...W,session_hash:p},v)).then(async([v,j])=>{if(j===503)n({type:"status",stage:"error",message:fe,queue:!0,endpoint:h,fn_index:u,time:new Date});else if(j!==200)n({type:"status",stage:"error",message:F,queue:!0,endpoint:h,fn_index:u,time:new Date});else{S=v.event_id;let B=async function(X){try{const{type:z,status:b,data:x}=ne(X,Q[u]);if(z=="heartbeat")return;if(z==="update"&&b&&!D)n({type:"status",endpoint:h,fn_index:u,time:new Date,...b});else if(z==="complete")D=b;else if(z=="unexpected_error")console.error("Unexpected error",b?.message),n({type:"status",stage:"error",message:b?.message||"An Unexpected Error Occurred!",queue:!0,endpoint:h,fn_index:u,time:new Date});else if(z==="log"){n({type:"log",log:x.log,level:x.level,endpoint:h,fn_index:u});return}else z==="generating"&&(n({type:"status",time:new Date,...b,stage:b?.stage,queue:!0,endpoint:h,fn_index:u}),x&&["sse_v2","sse_v2.1","sse_v3"].includes(q)&&st(V,S,x));x&&(n({type:"data",time:new Date,data:x.data,endpoint:h,fn_index:u}),x.render_config&&n({type:"render",data:x.render_config,endpoint:h,fn_index:u}),D&&n({type:"status",time:new Date,...D,stage:b?.stage,queue:!0,endpoint:h,fn_index:u})),(b?.stage==="complete"||b?.stage==="error")&&(K[S]&&delete K[S],S in V&&delete V[S])}catch(z){console.error("Unexpected client exception",z),n({type:"status",stage:"error",message:"An Unexpected Error Occurred!",queue:!0,endpoint:h,fn_index:u,time:new Date}),["sse_v2","sse_v2.1"].includes(q)&&(H(T,P),T.open=!1)}};S in k&&(k[S].forEach(X=>B(X)),delete k[S]),K[S]=B,ye.add(S),T.open||await this.open_stream()}})}}),{on:r,off:a,cancel:Y,destroy:i}}catch(n){throw console.error("Submit function encountered an error:",n),n}}function at(e,t,s,o){let n,r,a;if(typeof t=="number")n=t,r=e.unnamed_endpoints[n],a=o.dependencies[t];else{const i=t.replace(/^\//,"");n=s[i],r=e.named_endpoints[t.trim()],a=o.dependencies[s[i]]}if(typeof n!="number")throw new Error("There is no endpoint matching that name of fn_index matching that number.");return{fn_index:n,endpoint_info:r,dependency:a}}class ae extends Blob{constructor(t,s){super(t,s)}}class ie{constructor(t,s={}){_(this,"app_reference"),_(this,"options"),_(this,"config"),_(this,"api_info"),_(this,"api_map",{}),_(this,"session_hash",Math.random().toString(36).substring(2)),_(this,"jwt",!1),_(this,"last_status",{}),_(this,"stream_status",{open:!1}),_(this,"pending_stream_messages",{}),_(this,"pending_diff_streams",{}),_(this,"event_callbacks",{}),_(this,"unclosed_events",new Set),_(this,"heartbeat_event",null),_(this,"view_api"),_(this,"upload_files"),_(this,"upload"),_(this,"handle_blob"),_(this,"post_data"),_(this,"submit"),_(this,"predict"),_(this,"open_stream"),_(this,"resolve_config"),this.app_reference=t,this.options=s,this.view_api=Ge.bind(this),this.upload_files=Fe.bind(this),this.handle_blob=He.bind(this),this.post_data=Ve.bind(this),this.submit=rt.bind(this),this.predict=Ke.bind(this),this.open_stream=tt.bind(this),this.resolve_config=Ie.bind(this),this.upload=Me.bind(this)}fetch(t,s){return fetch(t,s)}async stream(t){if(typeof window>"u"||typeof EventSource>"u")try{const s=await ee(()=>import("./eventsource.4deb033a.js").then(function(o){return o.e}),["assets/eventsource.4deb033a.js","assets/__vite-browser-external.afb582f8.js","assets/_commonjsHelpers.294d03c4.js"]);return new s.default(t.toString())}catch(s){throw console.error("Failed to load EventSource module:",s),s}else return new EventSource(t.toString())}async init(){var t;if((typeof window>"u"||!("WebSocket"in window))&&!global.WebSocket){const s=await ee(()=>import("./wrapper-CviSselG.60495582.js"),["assets/wrapper-CviSselG.60495582.js","assets/__vite-browser-external.afb582f8.js"]);ae=(await ee(()=>import("./__vite-browser-external.afb582f8.js").then(function(o){return o._}),[])).Blob,global.WebSocket=s.WebSocket}try{await this._resolve_config().then(async({config:s})=>{if(this.config=s,s.space_id&&this.options.hf_token&&(this.jwt=await ke(s.space_id,this.options.hf_token)),this.config&&this.config.connect_heartbeat){const o=new URL(`${this.config.root}/heartbeat/${this.session_hash}`);this.jwt&&o.searchParams.set("__sign",this.jwt),this.heartbeat_event=await this.stream(o)}})}catch(s){throw Error(J+s.message)}this.api_info=await this.view_api(),this.api_map=qe(((t=this.config)==null?void 0:t.dependencies)||[])}static async connect(t,s={}){const o=new this(t,s);return await o.init(),o}close(){var t;(t=this.heartbeat_event)==null||t.close()}static async duplicate(t,s={}){return Xe(t,s)}async _resolve_config(){const{http_protocol:t,host:s,space_id:o}=await ge(this.app_reference,this.options.hf_token),{status_callback:n}=this.options;let r;try{if(r=await this.resolve_config(`${t}//${s}`),!r)throw new Error(J);return this.config_success(r)}catch(a){console.error(a),o?re(o,me.test(o)?"space_name":"subdomain",this.handle_space_success):n&&n({status:"error",message:"Could not load this space.",load_status:"error",detail:"NOT_FOUND"})}}async config_success(t){if(this.config=t,typeof window<"u"&&window.location.protocol==="https:"&&(this.config.root=this.config.root.replace("http://","https://")),this.config.auth_required)return this.prepare_return_obj();try{this.api_info=await this.view_api()}catch(s){console.error(Ce+s.message)}return this.prepare_return_obj()}async handle_space_success(t){const{status_callback:s}=this.options;if(s&&s(t),t.status==="running")try{if(this.config=await this._resolve_config(),!this.config)throw new Error(J);return await this.config_success(this.config)}catch(o){console.error(o),s&&s({status:"error",message:"Could not load this space.",load_status:"error",detail:"NOT_FOUND"})}}async component_server(t,s,o){var n;if(!this.config)throw new Error(J);const r={},{hf_token:a}=this.options,{session_hash:i}=this;a&&(r.Authorization=`Bearer ${this.options.hf_token}`);let l,d=this.config.components.find(c=>c.id===t);(n=d?.props)!=null&&n.root_url?l=d.props.root_url:l=this.config.root;let f;if("binary"in o){f=new FormData;for(const c in o.data)c!=="binary"&&f.append(c,o.data[c]);f.set("component_id",t.toString()),f.set("fn_name",s),f.set("session_hash",i)}else f=JSON.stringify({data:o,component_id:t,fn_name:s,session_hash:i}),r["Content-Type"]="application/json";a&&(r.Authorization=`Bearer ${a}`);try{const c=await this.fetch(`${l}/component_server/`,{method:"POST",body:f,headers:r});if(!c.ok)throw new Error("Could not connect to component server: "+c.statusText);return await c.json()}catch(c){console.warn(c)}}prepare_return_obj(){return{config:this.config,predict:this.predict,submit:this.submit,view_api:this.view_api,component_server:this.component_server}}}const L=he.BUILD_ENABLE_CHATBOT_DUMMY_DATA_MODE,R=window.location.origin,pe=he.BUILD_CHATBOT_API_DOMAIN_STAGING,it=async()=>(console.log("connect to : ",pe),await ie.connect(pe)),ct=async()=>L?await w.get(`${R}/dummyData/chatbot/chatbotGetHistoryListSample.json`):await w.get("groups"),lt=async e=>L?await w.get(`${R}/dummyData/chatbot/chatbotDeleteHistorySample.json`):await w.del(`groups/${e}`),ut=async(e,t)=>(console.log("patch bookcase: ",e,t),L?await w.get(`${R}/dummyData/chatbot/chatbotPatchHistorySample.json`):await w.patch(`groups/${e}`,t)),pt=async e=>{if(L){const t=await w.get(`${R}/dummyData/chatbot/chatbotGetHistorySampleWithReference.json`);return e!=="b1"?t:{result:{page_title:"No history",history_messages:[]}}}else return await w.get(`messages/${e}`)},ht=async e=>{if(L){const t=e==="zh"?"Zh":e==="ja"?"Ja":"En";return await w.get(`${R}/dummyData/chatbot/chatbotGetRecommendSample${t}.json`)}else{const t=e==="zh"?"Zh":e==="ja"?"Ja":"En";return await w.get(`${R}/dummyData/chatbot/chatbotGetRecommendSample${t}.json`)}},dt=async(e,t,s,o)=>{try{if(console.log("send message: ",[s.message,t,o]),L){const n=await e.predict("/messages",[[s.message,"docRLtest, docRL",o],s.history,2048,.7,.95,null]);return console.log("response: ",n),n.data[0]}else return(await w.get(`${R}/dummyData/chatbot/chatbotGetResponseSample.json`)).data[0]}catch(n){throw console.error("Error message:",n),n}},ft=async e=>L?await w.get(`${R}/dummyData/chatbot/chatbotGetDirectoriesSample.json`):await w.get(`chatbot_directories/${e}`),_t=async e=>(console.log("message: ",e),L?await w.get(`${R}/dummyData/chatbot/chatbotPostReportBadResponseSample.json`):await w.get(`chatbot_report/${e}`)),mt=e=>e.map(s=>({...s,nodes:s.nodes.map(o=>({...o,selected:!1}))})),gt=async e=>{console.log("setChatbotScope: ",e)},wt=async e=>L?await w.get(`${R}/dummyData/chatbot/chatbotGetReferencesSample.json`):await w.get(`references/${e}`);var bt={initAppClient:it,getConversations:ct,deleteConversation:lt,patchConversation:ut,getHistoryMessages:pt,getRecommendPrompts:ht,postMessage:dt,getDirectories:ft,processDirectories:mt,setChatbotScope:gt,getReferences:wt,reportBadResponse:_t};export{bt as C};
