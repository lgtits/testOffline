import{Q as ge,_ as he,p as fe,a as ye}from"./promptLangOptions.d1c6d61b.js";import{_ as be,d as Ce,k as we,r as n,h as Ae,i as Te,a as m,S as ke,l as Ee,be as Me,o as l,e as r,g as a,n as N,t as g,q as v,y as I,f as u,x as L,u as y,bj as Oe,F as b,aH as R,w as z,s as te,p as V,a$ as Ne,bh as Ie,aO as ae,bi as Re,b3 as De,aI as Be,aJ as Se}from"./index.a85485c5.js";import{Q as He}from"./QSelect.78232c23.js";import{F as j}from"./Format.45ca4c10.js";import{N as oe}from"./Notify.bbe52f7e.js";import{C as h}from"./OnlineChatbotServices.e4b38113.js";import{D as $e}from"./Dialog.cee19179.js";import"./QItemSection.af91e7b8.js";import"./QItemLabel.53394a7d.js";import"./format.1bd44e93.js";const Pe=D=>(Be("data-v-c315cbcc"),D=D(),Se(),D),xe={key:0,class:"chatbot-page"},Ue={class:"chatbot-header"},qe={class:"title"},Fe={key:0,class:"routes"},Le={class:"header-title q-mb-sm row justify-between"},ze={class:"row toggle-wrapper"},Ve={key:0,class:"toggle-on-demand"},je={class:"route-wrapper row justify-between"},Qe={class:""},Ge={class:"route-index q-mr-sm"},We={class:"nodes row items-center"},Je=["onClick"],Ke={key:0,class:"q-mx-xs"},Xe={class:"btn"},Ye={key:0,class:"apply-button"},Ze={class:"chatbot-page__message-area column"},es=Pe(()=>a("div",{class:"sidebar-title q-mb-sm"},"References:",-1)),ss={class:"sources q-ml-sm column"},ts={href:"",class:""},as={class:"q-mr-xs icon-wrapper"},os=["href"],ls={class:"report-button"},ns={key:0,class:"message user-message"},rs={key:1,class:"row items-center justify-end"},is={class:"q-ml-xs text-negative"},cs={key:2,class:"message"},us={class:"chatbot-footer"},ds={key:0,class:"lang-select row justify-end"},_s={class:"chatbot-footer__content"},ps={class:"chatbot-footer__content__input row w-100 full-width justify-between items-center"},vs=["placeholder","onKeydown"],ms=Ce({__name:"OnlineChatbotPageDir",setup(D){const{t:Q,locale:G}=we(),le=n(!1),f=n(),k=n(),W=n(!1),J=n(""),_=n(""),ne=Ae(),B=Te(()=>ne.params.bookcaseId.toString()),K=n(),d=n(),$=n(),E=n(),P=n(!1),C=n(!0),X=n(),w=n([]),x=n([]),S=n(""),U=n(m.BUILD_CHATBOT_TEXTAREA_LANGUAGE),M=n(),H=n(!0),A=n(m.RUNTIME_EXPAND_CHATBOT_DATA_SCOPE_MENU&&m.RUNTIME_ENABLE_CHATBOT_DATA_SCOPE_MODIFICATION),q=n(m.RUNTIME_ENABLE_CHATBOT_DATA_SCOPE_MODIFICATION),Y=()=>{q.value&&(A.value=!A.value)},O=async s=>{if(!C.value)return;$.value=s,_.value="",P.value=!0,C.value=!1;const e=w.value.join(",");try{const o=await h.postMessage(K.value,e,{message:s,history:d.value},U.value);d.value=o,P.value=!1,E.value=""}catch(o){E.value=o.message||"Error"}finally{C.value=!0}k.value.scrollTop=k.value.scrollHeight},re=async s=>{const e=await h.getRecommendPrompts(s);X.value=e.result.recommend_prompts},ie=async s=>{const e=await h.getHistoryMessages(s);d.value=e.result.history_messages,J.value=e.result.page_title},ce=async s=>{if(m.RUNTIME_SHOW_CHATBOT_DATA_SCOPE_REFERENCES){S.value=s;const e=await h.getReferences(s);x.value=e.result.references}},ue=async()=>{w.value=[B.value];const e=(await h.getDirectories(B.value)).result.data;M.value=h.processDirectories(e)},Z=async()=>{w.value=[],M.value?.forEach(s=>{let e=s.nodes.find(o=>o.selected===!0);e&&w.value.push(e.id)}),w.value.length||(w.value=[B.value])},de=async(s,e,o)=>{o||(M.value=M.value?.map((i,t)=>{if(t===s){let p=!1,c=!1,T=!1;return{...i,nodes:i.nodes.map((F,se)=>(se===e&&(p=!0,c=!F.selected),p&&se>e&&(T=c),{...F,selected:c,prevNodeSelected:T}))}}return i}),H.value&&(Z(),await _e()))};ke(()=>_.value,s=>{f.value.style.height="25px";const e=m.RUNTIME_CHATBOT_TEXTAREA_HEIGHT;if(s){if(f.value.clientHeight>=e)return;const o=f.value.scrollHeight>=e?e:f.value.scrollHeight;f.value.style.height="25px",f.value.style.height=o+"px"}});const _e=async()=>{console.log("resend request");let s="";for(let o=d.value.length-1;o>=0;o--){const i=d.value[o]?.[0];if(i){const t=i.replace(/'/g,'"');s=JSON.parse(t)[0];break}}const e=o=>{for(let i=o.length-1;i>=0;i--)if(o[i][0]!==null)return o.slice(0,i);return o};d.value=e(d.value),await O(s)},pe=()=>{if(!_.value)for(let s=d.value.length-1;s>=0;s--){const e=d.value[s]?.[0];if(e){const o=e.replace(/'/g,'"'),t=JSON.parse(o)[0];_.value=t;return}}},ve=async()=>{try{K.value=await h.initAppClient()}catch{oe.error(Q("$i18n_Connection_Error_$i18n"))}},ee=async s=>{console.log("page init: ",s),await ue(),await ie(s),await re(G.value),W.value=!0},me=s=>{console.log("report: ",s),$e.confirm({title:G.value==="zh"?"\u60A8\u5C0D\u9019\u500B\u56DE\u7B54\u4E0D\u6EFF\u610F\u55CE\uFF1F":"Are you dissatisfied with this answer?",message:"",onOk:async()=>{const e=await h.reportBadResponse(s);console.log(e),oe.error(Q("$i18n_Reported_$i18n"))}})};return Ee(async()=>{await ee(B.value),await ve(),k.value.scrollTop=k.value.scrollHeight}),Me(async(s,e,o)=>{o(),await ee(s.params.bookcaseId.toString())}),(s,e)=>{const o=ye,i=he;return W.value?(l(),r("div",xe,[a("div",Ue,[a("div",{class:N(["document-title row justify-center items-center",{"q-mb-sm":A.value}])},[a("span",qe,g(J.value),1),!A.value&&q.value?(l(),r("div",{key:0,class:"row expand-scope items-center cursor-pointer",onClick:Y},[v(I,{name:"sym_o_expand_circle_down",class:"",size:"sm"})])):u("",!0)],2),A.value?(l(),r("div",Fe,[a("div",Le,[L(g(s.$t("$i18n_RAG_data_scope_$i18n"))+": ",1),a("div",ze,[y(m).RUNTIME_ENABLE_CHATBOT_DATA_SCOPE_ON_DEMAND?(l(),r("div",Ve,[v(Oe,{modelValue:H.value,"onUpdate:modelValue":e[0]||(e[0]=t=>H.value=t),label:`On-demand ${s.$t("$i18n_Mode_$i18n")}`,"left-label":"",color:"indigo-7",disabled:""},null,8,["modelValue","label"])])):u("",!0),A.value&&q.value?(l(),r("div",{key:1,class:"row items-center cursor-pointer expand-btn-wrapper",onClick:Y},[v(I,{name:"sym_o_expand_circle_up",class:"q-mr-sm",size:"sm"})])):u("",!0)])]),a("div",je,[a("div",Qe,[(l(!0),r(b,null,R(M.value,(t,p)=>(l(),r("div",{class:"route row items-center q-mb-sm",key:t.id},[a("div",Ge,g(t.id)+".",1),a("div",We,[(l(!0),r(b,null,R(t.nodes,(c,T)=>(l(),r(b,{key:c.id},[a("div",{class:N(["node",{active:c.selected,disabled:c.prevNodeSelected}]),onClick:F=>de(p,T,c.prevNodeSelected)},g(c.name),11,Je),T<t.nodes.length-1?(l(),r("div",Ke," / ")):u("",!0)],64))),128))])]))),128))]),a("div",Xe,[H.value?u("",!0):(l(),r("div",Ye,[v(te,{style:{background:"#3e52b5",color:"white"},push:"",size:"md",onClick:Z},{default:z(()=>[L(g(s.$t("$i18n_APPLY_$i18n")),1)]),_:1})]))])])])):u("",!0)]),a("div",Ze,[x.value.length?(l(),r("div",{key:0,class:N(["chatbot-page__sidebar customized-scrollbar column justify-between",{collapse:le.value}])},[es,a("div",ss,[(l(!0),r(b,null,R(x.value,(t,p)=>(l(),r("div",{class:"source",key:t.referenceId},[a("a",ts,[a("span",as," ["+g(p+1)+"] ",1),a("a",{href:t.url,target:"_blank",class:"origin-name"},g(t.name),9,os)])]))),128))]),a("div",ls,[v(te,{icon:"report",color:"primary",label:"Bad Response",onClick:e[1]||(e[1]=t=>me(S.value))})])],2)):u("",!0),a("div",{class:"chatbot-message-wrapper customized-scrollbar column",ref_key:"messageWrapper",ref:k},[(l(!0),r(b,null,R(d.value,t=>(l(),r(b,{key:t},[(l(!0),r(b,null,R(t,(p,c)=>(l(),V(o,{key:p,message:p,role:c===0?"user":c===1?"bot":"id",messageId:y(j).getChatbotResponseId(t[1]),selectedMessage:!!(S.value&&y(j).getChatbotResponseId(t[1])===S.value&&c===1),onClick:T=>ce(y(j).getChatbotResponseId(t[1]))},null,8,["message","role","messageId","selectedMessage","onClick"]))),128))],64))),128)),P.value?(l(),r("div",ns,[L(g($.value)+" ",1),E.value?(l(),V(I,{key:0,class:"restart-btn",name:"sym_o_restart_alt",size:"md",onClick:e[2]||(e[2]=t=>O($.value))})):u("",!0)])):u("",!0),E.value?(l(),r("div",rs,[v(I,{name:"sym_o_error",color:"negative"}),a("span",is,g(E.value),1)])):u("",!0),C.value?u("",!0):(l(),r("div",cs,[v(ge,{color:"primary",size:"2em"})]))],512),!d.value.length&&y(m).RUNTIME_SHOW_CHATBOT_RECOMMEND_PROMPT?(l(),V(i,{key:1,options:X.value,onSubmitOption:O},null,8,["options"])):u("",!0),a("div",us,[y(m).RUNTIME_SHOW_CHATBOT_PROMPT_LANGUAGE?(l(),r("div",ds,[v(He,{dense:"",borderless:"",modelValue:U.value,"onUpdate:modelValue":e[3]||(e[3]=t=>U.value=t),options:y(fe),behavior:"menu","emit-value":""},{prepend:z(()=>[v(Re,null,{default:z(()=>[v(I,{name:"sym_o_language",size:"sm"})]),_:1})]),_:1},8,["modelValue","options"])])):u("",!0),a("div",_s,[a("div",ps,[Ne(a("textarea",{rows:"1",class:"customized-scrollbar",placeholder:s.$t("$i18n_Input_problem_$i18n"),ref_key:"textareaBlock",ref:f,"onUpdate:modelValue":e[4]||(e[4]=t=>_.value=t),onKeydown:[ae(pe,["up"]),e[5]||(e[5]=ae(De(t=>O(_.value),["alt"]),["enter"]))]},null,40,vs),[[Ie,_.value]]),a("div",{class:N(["submit-btn",{"cursor-pointer":_.value&&C.value}]),onClick:e[6]||(e[6]=t=>O(_.value))},[a("img",{src:"/images/icons/submit_btn.svg",alt:"",class:N({empty:!_.value||!C.value})},null,2)],2)])])])])])):u("",!0)}}});var Es=be(ms,[["__scopeId","data-v-c315cbcc"]]);export{Es as default};
